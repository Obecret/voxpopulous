Tu es un d√©veloppeur full-stack expert et tu vas cr√©er une application SaaS multi-tenant appel√©e **"CivisBox"**, con√ßue pour les **mairies / communes**.

Objectif :  
CivisBox est une plateforme en ligne qui propose :
1) Une **landing page SaaS** pour pr√©senter l‚Äôoffre aux communes  
2) Une **inscription / demande d‚Äôinformations** pour les communes  
3) Pour chaque commune inscrite (tenant) :
   - Une **landing publique "citoyenne"** d√©di√©e √† la commune pour expliquer l‚Äôoutil et rediriger vers les services
   - Une **bo√Æte √† id√©es citoyenne** (propositions, votes, suivi de statut)
   - Un **outil de signalement d‚Äôincidents** (trous dans la route, lampadaire en panne, etc.)
   - Un module **R√©unions √©lus/citoyens** :
     - calendrier de r√©unions
     - liste d‚Äôid√©es d√©battues √† chaque r√©union
     - inscription des citoyens aux r√©unions

L‚Äôapplication est **multi-tenant** : plusieurs communes utilisent la m√™me app, chacune avec ses donn√©es isol√©es.

### üß± STACK TECHNIQUE

- Backend : Node.js + Express
- ORM : Prisma
- Base de donn√©es : SQLite pour le MVP (facilement migrable vers Postgres ensuite)
- Templates : EJS (rendu c√¥t√© serveur)
- Static : CSS simple dans `/public`
- Authentification : `express-session` + bcrypt pour les admins des communes
- Architecture monolithique simple, pr√™te √† tourner sur Replit.

---

## 1. Mod√©lisation des donn√©es (Prisma)

Cr√©e un fichier `prisma/schema.prisma` avec les mod√®les suivants (√† √©crire correctement en syntaxe Prisma) :

### 1.1. Tenants & utilisateurs

- **Tenant** (une commune / structure)
  - id            String   @id @default(cuid())
  - name          String         // "Puiseux-en-France"
  - slug          String @unique // "puiseux-en-france"
  - contactEmail  String?
  - contactName   String?
  - subscriptionPlan   String    // "FREE_TRIAL", "STANDARD", "PREMIUM"
  - billingStatus      String    // "TRIAL", "ACTIVE", "SUSPENDED", "CANCELLED"
  - trialEndsAt        DateTime?
  - createdAt     DateTime @default(now())
  - updatedAt     DateTime @updatedAt
  - users         User[]
  - ideas         Idea[]
  - incidents     Incident[]
  - meetings      Meeting[]

- **User** (admin / mod√©rateur de la commune)
  - id            String   @id @default(cuid())
  - tenantId      String
  - tenant        Tenant   @relation(fields: [tenantId], references: [id])
  - name          String
  - email         String   @unique
  - passwordHash  String
  - role          UserRole // enum: "ADMIN", "MODERATOR"
  - createdAt     DateTime @default(now())

- **UserRole** (enum Prisma)
  - ADMIN
  - MODERATOR

---

### 1.2. Leads / demandes d‚Äôinfos (pour la landing SaaS globale)

- **Lead**
  - id            String   @id @default(cuid())
  - organisationName String
  - contactName   String
  - email         String
  - phone         String?
  - message       String?
  - createdAt     DateTime @default(now())
  - status        String   // "NEW", "CONTACTED", "CONVERTED", "IGNORED"

---

### 1.3. Bo√Æte √† id√©es

- **Idea**
  - id            String   @id @default(cuid())
  - tenantId      String
  - tenant        Tenant   @relation(fields: [tenantId], references: [id])
  - title         String
  - description   String
  - category      String
  - status        IdeaStatus // "NEW", "UNDER_REVIEW", "IN_PROGRESS", "DONE", "REJECTED"
  - createdByEmail String?
  - publicToken    String  @unique
  - votesCount     Int     @default(0)
  - createdAt      DateTime @default(now())
  - updatedAt      DateTime @updatedAt
  - votes          IdeaVote[]
  - meetings       MeetingIdea[]

- **IdeaStatus** (enum)
  - NEW
  - UNDER_REVIEW
  - IN_PROGRESS
  - DONE
  - REJECTED

- **IdeaVote**
  - id        String   @id @default(cuid())
  - ideaId    String
  - idea      Idea     @relation(fields: [ideaId], references: [id])
  - voterIp   String?
  - voterEmail String?
  - createdAt DateTime @default(now())

---

### 1.4. Incidents

- **Incident**
  - id            String   @id @default(cuid())
  - tenantId      String
  - tenant        Tenant   @relation(fields: [tenantId], references: [id])
  - title         String
  - description   String
  - category      String   // "voirie", "√©clairage", "propret√©", "s√©curit√©", "autre"
  - status        IncidentStatus // "NEW", "ACKNOWLEDGED", "IN_PROGRESS", "RESOLVED", "REJECTED"
  - locationText  String
  - createdByEmail String?
  - publicToken   String @unique
  - createdAt     DateTime @default(now())
  - updatedAt     DateTime @updatedAt

- **IncidentStatus** (enum)
  - NEW
  - ACKNOWLEDGED
  - IN_PROGRESS
  - RESOLVED
  - REJECTED

---

### 1.5. R√©unions √©lus / citoyens

- **Meeting** (r√©union publique / conseil participatif)
  - id            String   @id @default(cuid())
  - tenantId      String
  - tenant        Tenant   @relation(fields: [tenantId], references: [id])
  - title         String       // "R√©union de quartier centre-ville"
  - description   String?
  - dateTime      DateTime     // date + heure
  - location      String       // lieu de la r√©union
  - status        MeetingStatus // "SCHEDULED", "COMPLETED", "CANCELLED"
  - capacity      Int?         // nombre max de participants (optionnel)
  - createdAt     DateTime @default(now())
  - updatedAt     DateTime @updatedAt
  - ideas         MeetingIdea[]
  - registrations MeetingRegistration[]

- **MeetingStatus** (enum)
  - SCHEDULED
  - COMPLETED
  - CANCELLED

- **MeetingIdea** (table de liaison r√©union ‚Üî id√©es d√©battues)
  - id        String   @id @default(cuid())
  - meetingId String
  - ideaId    String
  - meeting   Meeting @relation(fields: [meetingId], references: [id])
  - idea      Idea    @relation(fields: [ideaId], references: [id])

- **MeetingRegistration** (inscription d‚Äôun citoyen √† une r√©union)
  - id         String   @id @default(cuid())
  - meetingId  String
  - meeting    Meeting  @relation(fields: [meetingId], references: [id])
  - fullName   String
  - email      String
  - comment    String?
  - createdAt  DateTime @default(now())

---

## 2. Multi-tenant : logique

Comme pr√©c√©demment, utiliser un middleware bas√© sur le `tenantSlug` dans l‚ÄôURL :

- Toutes les routes "commune" seront pr√©fix√©es par :

  - `/t/:tenantSlug/...`

Cr√©er un middleware :

- `loadTenantFromSlug` :
  - cherche en base le `Tenant` via `slug = req.params.tenantSlug`
  - si trouv√© ‚Üí `req.tenant = tenant`
  - sinon ‚Üí 404

Toutes les requ√™tes Prisma li√©es √† Idea, Incident, Meeting, etc. doivent **toujours filtrer par `tenantId = req.tenant.id`**.

---

## 3. Authentification ADMIN par commune

- Utiliser `express-session` pour stocker l‚Äô`userId` et `tenantId`.
- Cr√©er un seed :
  - Tenant de test `"Puiseux-en-France"` slug `"puiseux-en-france"`
  - User admin : `admin@puiseux.fr` / mot de passe `"admin123"` (hash√© avec bcrypt).
- Routes admin :
  - `GET  /t/:tenantSlug/admin/login`
  - `POST /t/:tenantSlug/admin/login`
  - `POST /t/:tenantSlug/admin/logout`

Middleware : `requireAdmin` :

- V√©rifie :
  - `req.session.user` pr√©sent
  - `req.session.user.tenantId === req.tenant.id`
- Sinon ‚Üí rediriger vers la page de login admin.

---

## 4. Landing SaaS globale (pour toutes les communes)

Ces routes ne sont pas multi-tenant, elles sont au niveau racine de l‚Äôapp :

1. `GET /`
   - Page d‚Äôaccueil de CivisBox :
     - Explication courte de la solution
     - Section ‚ÄúComment √ßa marche ?‚Äù
     - CTA "D√©couvrir les tarifs" + "Demander une d√©mo"

2. `GET /pricing`
   - Pr√©senter 2 ou 3 plans :
     - "Essai gratuit" (15 jours)
     - "Standard"
     - "Premium"
   - Ce n‚Äôest que de l‚Äôaffichage, pas d‚Äôint√©gration de paiement r√©elle pour le MVP (mais pr√©voir dans le mod√®le `subscriptionPlan` et `billingStatus`).

3. `GET /contact`
   - Formulaire pour les communes :
     - Nom de la commune / structure
     - Nom du contact
     - Email
     - T√©l√©phone (optionnel)
     - Message

4. `POST /contact`
   - Cr√©er un `Lead` en base
   - Afficher une page de remerciement
   - Faire un `console.log` comme si on notifie l‚Äô√©quipe commerciale.

5. `GET /signup`
   - Formulaire pour cr√©er un compte de test (essai gratuit) pour une commune :
     - Nom de la commune
     - Slug souhait√© (pr√©-rempli √† partir du nom)
     - Email de l‚Äôadmin
     - Nom de l‚Äôadmin
     - Mot de passe

6. `POST /signup`
   - Cr√©e :
     - un `Tenant` avec :
       - `subscriptionPlan = "FREE_TRIAL"`
       - `billingStatus = "TRIAL"`
       - `trialEndsAt = now() + 15 jours` (par exemple)
     - un `User` admin li√© √† ce tenant
   - Redirige vers : `/t/:tenantSlug/admin/login` avec un message de succ√®s.
   - Pas d‚Äôint√©gration Stripe dans ce MVP, mais le mod√®le `Tenant` pr√©pare la suite.

---

## 5. Landing citoyenne par commune

Chaque commune a une **landing publique** pour expliquer l‚Äôoutil √† ses habitants :

1. `GET /t/:tenantSlug`
   - Page de pr√©sentation citoyenne pour **ce tenant** :
     - Nom de la commune (`req.tenant.name`)
     - Texte marketing : ‚ÄúVotre ville vous donne la parole‚Äù
     - 3 grandes sections avec boutons :
       - ‚ÄúProposer une id√©e‚Äù ‚Üí lien vers `/t/:tenantSlug/ideas`
       - ‚ÄúSignaler un probl√®me‚Äù ‚Üí lien vers `/t/:tenantSlug/incidents`
       - ‚ÄúParticiper aux r√©unions‚Äù ‚Üí lien vers `/t/:tenantSlug/meetings`
   - C‚Äôest la page que la mairie pourra diffuser sur son site / r√©seaux.

---

## 6. Bo√Æte √† id√©es citoyenne (public + admin)

### 6.1. C√¥t√© citoyens (public)

1. `GET /t/:tenantSlug/ideas`
   - Liste des id√©es de la commune
   - Filtres par `status` (`?status=...`) et `category`
   - Affiche : titre, cat√©gorie, statut (badge couleur), nombre de votes.

2. `GET /t/:tenantSlug/ideas/new`
   - Formulaire :
     - titre (obligatoire)
     - description (obligatoire)
     - cat√©gorie (liste d√©roulante ou champ texte)
     - email (optionnel)

3. `POST /t/:tenantSlug/ideas`
   - Cr√©e une nouvelle `Idea` :
     - `tenantId = req.tenant.id`
     - `status = "NEW"`
     - `votesCount = 0`
     - `publicToken` g√©n√©r√©
   - Si email fourni ‚Üí stocker dans `createdByEmail`
   - Affiche une page de confirmation avec lien de suivi :
     - `/t/:tenantSlug/ideas/track/:publicToken`

4. `GET /t/:tenantSlug/ideas/track/:publicToken`
   - Page de suivi :
     - Titre, description, cat√©gorie, statut
     - Explication de la signification du statut

5. `POST /t/:tenantSlug/ideas/:id/vote`
   - Ajoute un `IdeaVote` (limiter un vote par IP pour simplifier : v√©rifier s‚Äôil existe d√©j√† un vote pour cette id√©e avec `voterIp = req.ip`)
   - Incr√©mente `votesCount`
   - Redirige vers la liste avec un message.

### 6.2. C√¥t√© admin (commune)

1. `GET /t/:tenantSlug/admin/ideas`
   - Tableau des id√©es :
     - colonnes : titre, cat√©gorie, statut, votes, date, email
     - filtres par statut

2. `GET /t/:tenantSlug/admin/ideas/:id`
   - D√©tail :
     - infos compl√®tes
     - liste des r√©unions o√π l‚Äôid√©e est d√©battue (via `MeetingIdea`)
   - Formulaire pour modifier :
     - `status` (s√©lecteur)
   - Bouton pour ajouter / retirer l‚Äôid√©e d‚Äôune r√©union (associer √† un `Meeting` existant).

3. `POST /t/:tenantSlug/admin/ideas/:id/status`
   - Met √† jour le statut.
   - `updatedAt` mis √† jour.
   - Si `createdByEmail` existe ‚Üí faire un `console.log` qui simule l‚Äôenvoi d‚Äôun email d‚Äôinfo au citoyen.

---

## 7. Signalements d‚Äôincidents

### 7.1. C√¥t√© citoyens

1. `GET /t/:tenantSlug/incidents`
   - Liste des incidents signal√©s
   - Filtres :
     - `status`
     - `category`
   - Affiche : titre, lieu, statut, date.

2. `GET /t/:tenantSlug/incidents/new`
   - Formulaire :
     - titre
     - description
     - cat√©gorie (voirie, √©clairage, propret√©, s√©curit√©, autre)
     - localisation texte (obligatoire)
     - email (optionnel)

3. `POST /t/:tenantSlug/incidents`
   - Cr√©e un `Incident` :
     - `status = "NEW"`
     - `publicToken` g√©n√©r√©
   - Page de confirmation avec lien :
     - `/t/:tenantSlug/incidents/track/:publicToken`

4. `GET /t/:tenantSlug/incidents/track/:publicToken`
   - D√©tailler le signalement + statut.

### 7.2. C√¥t√© admin

1. `GET /t/:tenantSlug/admin/incidents`
   - Tableau avec filtres par statut.

2. `GET /t/:tenantSlug/admin/incidents/:id`
   - D√©tail + formulaire pour changer `status`.

3. `POST /t/:tenantSlug/admin/incidents/:id/status`
   - Met √† jour le statut
   - Si `createdByEmail` non nul ‚Üí `console.log` pour simuler Notification.

---

## 8. R√©unions √©lus / citoyens

### 8.1. C√¥t√© citoyens

1. `GET /t/:tenantSlug/meetings`
   - Liste des r√©unions √† venir (`status = "SCHEDULED"`, `dateTime >= now()`), tri√©es par date.
   - Possibilit√© d‚Äôafficher les r√©unions pass√©es sur une autre section.

2. `GET /t/:tenantSlug/meetings/:id`
   - D√©tail de la r√©union :
     - titre, description, date/heure, lieu, statut
     - nombre max de participants (si `capacity` non nul) + nombre actuel d‚Äôinscrits
     - liste des id√©es li√©es (en lecture seule) via `MeetingIdea` :
       - titre de l‚Äôid√©e + lien vers sa page de suivi public
   - Formulaire d‚Äôinscription :
     - Nom complet
     - Email
     - Commentaire (optionnel)
   - Si la capacit√© est atteinte (`registrations.length >= capacity`) :
     - D√©sactiver l‚Äôinscription et afficher un message.

3. `POST /t/:tenantSlug/meetings/:id/register`
   - V√©rifier :
     - `meeting.tenantId === req.tenant.id`
     - `meeting.status === "SCHEDULED"`
     - capacit√© non d√©pass√©e si `capacity` d√©fini
   - Cr√©er un `MeetingRegistration`
   - Afficher un message de confirmation (simuler un mail avec `console.log`).

### 8.2. C√¥t√© admin

1. `GET /t/:tenantSlug/admin/meetings`
   - Liste des r√©unions :
     - titre, date, lieu, statut, nombre d‚Äôinscrits

2. `GET /t/:tenantSlug/admin/meetings/new`
   - Formulaire :
     - titre
     - description
     - date + heure
     - lieu
     - statut (par d√©faut `SCHEDULED`)
     - capacit√© (optionnelle)

3. `POST /t/:tenantSlug/admin/meetings`
   - Cr√©er la r√©union.

4. `GET /t/:tenantSlug/admin/meetings/:id`
   - D√©tail de la r√©union
   - Liste des inscrits (nom, email, commentaire)
   - Interface pour :
     - changer `status` (SCHEDULED ‚Üí COMPLETED ou CANCELLED)
     - lier/d√©lier des id√©es :
       - afficher la liste des id√©es `Idea` du tenant, avec cases √† cocher, pour cr√©er ou supprimer des `MeetingIdea`.

5. `POST /t/:tenantSlug/admin/meetings/:id/status`
   - Met √† jour le statut
   - Option : simuler l‚Äôenvoi d‚Äôemail aux inscrits via `console.log`.

---

## 9. Templates EJS

Cr√©er les templates EJS simples dans un dossier `views/` :

- `layouts/layout.ejs` : layout global avec header, nav, footer.
- Pages SaaS :
  - `home.ejs`        (pour `/`)
  - `pricing.ejs`     (pour `/pricing`)
  - `contact.ejs`     (formulaire de contact)
  - `contact-success.ejs`
  - `signup.ejs`      (inscription d‚Äôun nouveau tenant)
  - `signup-success.ejs`

- Pages communes (citoyens) :
  - `tenant/landing.ejs`     (pour `/t/:tenantSlug`)
  - `ideas/list.ejs`
  - `ideas/new.ejs`
  - `ideas/track.ejs`
  - `incidents/list.ejs`
  - `incidents/new.ejs`
  - `incidents/track.ejs`
  - `meetings/list.ejs`
  - `meetings/detail.ejs`

- Pages admin :
  - `admin/login.ejs`
  - `admin/dashboard.ejs` (vue globale simple : nb d‚Äôid√©es, incidents, r√©unions)
  - `admin/ideas/list.ejs`
  - `admin/ideas/detail.ejs`
  - `admin/incidents/list.ejs`
  - `admin/incidents/detail.ejs`
  - `admin/meetings/list.ejs`
  - `admin/meetings/new.ejs`
  - `admin/meetings/detail.ejs`

Style :
- Un fichier `public/styles.css` avec un design sobre (layout centr√©, cartes, badges de statuts avec couleurs diff√©rentes).

---

## 10. Fichier principal serveur

Cr√©er un `index.js` ou `server.js` qui :

- Initialise Express
- Configure :
  - EJS (`app.set('view engine', 'ejs')`)
  - `express.static('public')`
  - `express-session`
  - PrismaClient
  - middlewares `loadTenantFromSlug`, `requireAdmin`
- Monte les routes :
  - SaaS global (`/`, `/pricing`, `/contact`, `/signup`)
  - Communes publiques (`/t/:tenantSlug/...`)
  - Communes admin (`/t/:tenantSlug/admin/...`)

Pr√©voir un script `npm start` dans `package.json`.

---

## 11. Seed

Cr√©er `prisma/seed.js` :

- Cr√©e un tenant de test `"Puiseux-en-France"` (`slug: "puiseux-en-france"`) avec :
  - `subscriptionPlan = "FREE_TRIAL"`
  - `billingStatus = "TRIAL"`
  - `trialEndsAt = now() + 15 jours`
- Cr√©e un admin :
  - email : `admin@puiseux.fr`
  - mot de passe : `"admin123"` (hash√©)
- Quelques donn√©es de test :
  - 2‚Äì3 id√©es
  - 2‚Äì3 incidents
  - 1‚Äì2 r√©unions

---

But : g√©n√©rer le code complet, structur√© et comment√©, **pr√™t √† √™tre ex√©cut√© sur Replit** en suivant strictement ces sp√©cifications.
